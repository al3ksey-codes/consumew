{% extends "base.html" %}

{% block title %}{{ node_name }} - Randiostantsiya{% endblock %}

{% block head %}
<!-- No meta refresh, using AJAX polling instead -->
<script>
// Helper function to format timestamps in JavaScript
function formatTimestamp(ts) {
    // Insert a space before the "T" and append ", UTC+1"
    return ts.replace("T", " T ") + ", UTC+1";
}

async function fetchMessages() {
    try {
        const response = await fetch('/messages_json');
        if (response.ok) {
            const messages = await response.json();
            let container = document.getElementById('messages');
            let html = '';
            messages.forEach(function(message) {
                let messageClass = (message.sender === "{{ node_name }}") ? "sent" : "received";
                html += '<div class="message ' + messageClass + '">';
                html += '<div class="sender">' + message.sender + '</div>';
                // Format timestamp via JS helper (if desired, you can also pre-format on the server)
                html += '<div class="timestamp">' + formatTimestamp(message.timestamp) + '</div>';
                html += '<div class="text">' + message.message + '</div>';
                html += '</div>';
            });
            container.innerHTML = html;
        }
    } catch (error) {
        console.error('Error fetching messages:', error);
    }
}

// Poll for new messages every 5 seconds
setInterval(fetchMessages, 60000);
window.addEventListener('load', fetchMessages);
</script>
{% endblock %}

{% block content %}
<div id="messages">
    {% for message in messages %}
        {% if message.sender == node_name %}
            <div class="message sent">
                <div class="sender">{{ message.sender }}</div>
                <div class="timestamp">{{ message.timestamp|format_timestamp }}</div>
                <div class="text">{{ message.message }}</div>
            </div>
        {% else %}
            <div class="message received">
                <div class="sender">{{ message.sender }}</div>
                <div class="timestamp">{{ message.timestamp|format_timestamp }}</div>
                <div class="text">{{ message.message }}</div>
            </div>
        {% endif %}
    {% endfor %}
</div>
{% endblock %}
